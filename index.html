<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²‰æµ¸å¼èŠ‚æ—¥ç¥ç¦å¼•æ“</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; color: white; font-family: sans-serif; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; transition: opacity 0.5s; }
        #ui-layer { position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; pointer-events: none; }
        .btn { pointer-events: auto; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 10px 20px; border-radius: 20px; cursor: pointer; backdrop-filter: blur(5px); transition: 0.3s; }
        .btn:hover { background: rgba(255,255,255,0.3); }
    </style>
</head>
<body>

    <div id="loading">æ­£åœ¨è¿æ¥èŠ‚æ—¥å¼•æ“...</div>
    <div id="ui-layer">
        <h1 id="theme-title" style="font-weight: 200; letter-spacing: 2px; font-size: 1.2rem; opacity: 0.8;">åŠ è½½ä¸­...</h1>
        <button id="sound-btn" class="btn">ğŸ”Š å¼€å¯å£°éŸ³äº’åŠ¨</button>
    </div>

    <script type="module">
        import * as THREE from 'https://esm.sh/three@0.160.0';
        import { OrbitControls } from 'https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.0';

        // --- 1. é…ç½®ä¸æ•°æ®åº“è¿æ¥ ---
        const SUPABASE_URL = 'https://tcviiqrcgijnxgwmzjkq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_VmvFMbF53RtgkovrckT_fQ_V9vh6yFS'; // æ³¨æ„ï¼šè¿™æ˜¯ä½ çš„ Public Keyï¼Œå‰ç«¯å¯è§æ˜¯æ­£å¸¸çš„
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. åœºæ™¯åˆå§‹åŒ– ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.05); // é›¾æ°”æ•ˆæœï¼Œå¢åŠ æ·±é‚ƒæ„Ÿ

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 15;
        camera.position.y = 5;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.0;

        // --- 3. æ ¸å¿ƒè§†è§‰ï¼šç²’å­æ ‘ç”Ÿæˆå™¨ ---
        let particles;
        
        function createTree(config) {
            // æ¸…ç†æ—§åœºæ™¯
            if(particles) scene.remove(particles);

            const count = config.visual.particleCount || 2000;
            const color1 = new THREE.Color(config.visual.primaryColor || '#FFD700');
            const color2 = new THREE.Color(config.visual.secondaryColor || '#FF0000');

            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];

            // ç®—æ³•ï¼šç”Ÿæˆèºæ—‹å‘ä¸Šçš„åœ†é”¥ä½“ç²’å­
            for (let i = 0; i < count; i++) {
                // è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„èºæ—‹ç®—æ³•
                const angle = i * 0.1; 
                const radius = (count - i) * 0.005; // åº•éƒ¨å®½ï¼Œé¡¶éƒ¨çª„
                const y = (i * 0.01) - 5; // é«˜åº¦åˆ†å¸ƒ

                // åŠ å…¥ä¸€äº›éšæœºæ‰°åŠ¨ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´åƒè‡ªç„¶çš„æ ‘å¶/å…‰ç‚¹ï¼Œè€Œä¸æ˜¯æ­»æ¿çš„å‡ ä½•ä½“
                const randomX = (Math.random() - 0.5) * 0.5;
                const randomZ = (Math.random() - 0.5) * 0.5;
                const randomY = (Math.random() - 0.5) * 0.5;

                positions.push(
                    Math.cos(angle) * radius + randomX, 
                    y + randomY, 
                    Math.sin(angle) * radius + randomZ
                );

                // é¢œè‰²æ··åˆ
                const mixedColor = color1.clone().lerp(color2, Math.random());
                colors.push(mixedColor.r, mixedColor.g, mixedColor.b);
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.15,
                vertexColors: true,
                blending: THREE.AdditiveBlending, // å…‰å åŠ æ¨¡å¼ï¼Œçœ‹èµ·æ¥å‘å…‰
                depthWrite: false,
                transparent: true,
                opacity: 0.8
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // --- 4. æ•°æ®é©±åŠ¨é€»è¾‘ ---
        async function loadTheme() {
            // ä»æ•°æ®åº“æ‹‰å– 'active' ä¸º true çš„ä¸»é¢˜
            const { data, error } = await supabase
                .from('themes')
                .select('*')
                .eq('is_active', true)
                .single(); // åªå–ä¸€ä¸ª

            const titleEl = document.getElementById('theme-title');
            const loadingEl = document.getElementById('loading');

            if (error || !data) {
                console.warn('æ•°æ®åº“è¯»å–å¤±è´¥æˆ–æ— æ¿€æ´»ä¸»é¢˜ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½é…ç½®', error);
                // å¤±è´¥æ—¶çš„å…œåº•ï¼ˆæœ¬åœ°é»˜è®¤æ•ˆæœï¼‰
                createTree({
                    visual: { primaryColor: '#00ff00', secondaryColor: '#ffffff', particleCount: 3000 }
                });
                titleEl.innerText = "æœ¬åœ°å®‰å…¨æ¨¡å¼ (DBæœªè¿æ¥)";
            } else {
                console.log('ä» Supabase åŠ è½½é…ç½®æˆåŠŸ:', data.name);
                // ä½¿ç”¨æ•°æ®åº“é‡Œçš„é…ç½®æ¸²æŸ“ï¼
                createTree(data.config);
                titleEl.innerText = data.name;
                
                // åŠ¨æ€ä¿®æ”¹èƒŒæ™¯è‰²
                if(data.config.visual.backgroundColor) {
                    renderer.setClearColor(data.config.visual.backgroundColor);
                    scene.fog.color.set(data.config.visual.backgroundColor);
                }
            }
            
            loadingEl.style.opacity = 0;
        }

        // --- 5. æ¸²æŸ“å¾ªç¯ ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            controls.update();

            // ç®€å•çš„åŠ¨æ€å‘¼å¸æ•ˆæœ
            if (particles) {
                particles.rotation.y = time * 0.05; // æ•´ä½“ææ…¢è‡ªè½¬
                
                // æ¨¡æ‹Ÿç²’å­é—ªçƒ
                const sizes = particles.material.size;
                // è¿™é‡Œæœªæ¥å¯ä»¥æ¥å…¥éŸ³é¢‘æ•°æ® audioData æ¥æ§åˆ¶
            }

            renderer.render(scene, camera);
        }

        // --- 6. äº¤äº’ä¸å¯åŠ¨ ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // å¯åŠ¨ï¼
        loadTheme();
        animate();

    </script>
</body>
</html>
