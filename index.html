<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Magic Holiday Wishes</title>
    <style>
        /* === ç•Œé¢æ ·å¼ (CSS) === */
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Arial', sans-serif; color: white; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* å¯åŠ¨å±å¹• (å¼ºåˆ¶ç”¨æˆ·äº¤äº’ä»¥å¼€å¯å£°éŸ³/æ‘„åƒå¤´) */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s;
        }
        .start-btn {
            padding: 15px 40px; font-size: 24px; color: white;
            background: linear-gradient(45deg, #ff0055, #ffcc00);
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.5);
            animation: pulse 2s infinite;
        }

        /* UI å±‚ (ç¥ç¦è¯­ & æŒ‰é’®) */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none; /* è®©é¼ æ ‡ç©¿é€UIæ“ä½œ3D */
            display: none; /* å¯åŠ¨åæ˜¾ç¤º */
        }
        #wish-text {
            position: absolute; top: 15%; width: 100%;
            text-align: center; font-size: 2rem; font-weight: bold;
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
            pointer-events: none;
        }
        #create-btn {
            position: absolute; bottom: 30px; right: 30px;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255,255,255,0.5);
            color: white; font-size: 30px; line-height: 50px; text-align: center;
            cursor: pointer; pointer-events: auto; backdrop-filter: blur(5px);
            transition: transform 0.3s;
        }
        #create-btn:hover { transform: scale(1.1) rotate(90deg); background: rgba(255,255,255,0.4); }

        /* åˆ¶ä½œè¡¨å•å¼¹çª— */
        #modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px;
            background: rgba(20, 20, 20, 0.95); padding: 20px; border-radius: 15px;
            border: 1px solid #333; z-index: 100;
            display: none; pointer-events: auto;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        input, select, textarea {
            width: 100%; margin-bottom: 15px; padding: 10px;
            background: #333; border: 1px solid #555; color: white; border-radius: 5px;
            box-sizing: border-box;
        }
        button.submit-btn {
            width: 100%; padding: 12px; background: #0070f3; color: white; border: none; border-radius: 5px; cursor: pointer;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; cursor: pointer; color: #888; }
        
        /* åŠ è½½åŠ¨ç”» */
        #loading { position: fixed; bottom: 10px; left: 10px; color: #888; font-size: 12px; z-index: 1000; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="start-screen">
        <h1 style="margin-bottom: 20px;">ğŸ„ Magic Holiday ğŸ®</h1>
        <button class="start-btn" onclick="app.start()">å¼€å¯é­”æ³•ä¸–ç•Œ</button>
        <p style="margin-top: 10px; font-size: 12px; color: #aaa;">éœ€è¦æ‘„åƒå¤´(æ‰‹åŠ¿)å’Œéº¦å…‹é£(äº’åŠ¨)æƒé™</p>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="wish-text">Loading...</div>
        <div id="create-btn" onclick="ui.openModal()">+</div>
    </div>

    <div id="modal">
        <div class="close-btn" onclick="ui.closeModal()">âœ•</div>
        <h3 style="margin-top: 0;">å‘é€ä¸“å±ç¥ç¦ âœ¨</h3>
        <label>å¯¹æ–¹åå­— (ç”Ÿæˆé“¾æ¥ç”¨)</label>
        <input type="text" id="input-name" placeholder="ä¾‹å¦‚: zhangsan">
        
        <label>é€‰æ‹©æ—¥æœŸ (ç”Ÿæ—¥/çºªå¿µæ—¥)</label>
        <input type="text" id="input-date" placeholder="MM-DD (ä¾‹å¦‚: 05-20)">
        
        <label>é€‰æ‹©ç‰¹æ•ˆä¸»é¢˜</label>
        <select id="input-theme">
            <option value="1">ğŸ„ åœ£è¯æ ‘ (ç»¿è‰²)</option>
            <option value="2">ğŸ® æ˜¥èŠ‚ç¯ç¬¼ (çº¢è‰²)</option>
            <option value="3">ğŸ‚ ç”Ÿæ—¥è›‹ç³• (ç²‰è‰²)</option>
            <option value="4">ğŸ’– çˆ±å¿ƒ (ç«çº¢)</option>
        </select>
        
        <label>ç¥ç¦è¯­ (é€‰å¡«)</label>
        <textarea id="input-wish" rows="3" placeholder="å†™ç‚¹ä»€ä¹ˆ..."></textarea>
        
        <button class="submit-btn" onclick="ui.submitForm()">ç”Ÿæˆé“¾æ¥</button>
        <div id="result-link" style="margin-top:10px; word-break: break-all; color: #00ff00; font-size: 12px;"></div>
    </div>

    <div id="loading">Connecting to Database...</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // === A. é…ç½®åŒº (ä½ çš„å‚æ•°åœ¨è¿™é‡Œ) ===
        const CONFIG = {
            supabaseUrl: 'https://tcviiqrcgijnxgwmzjkq.supabase.co',
            supabaseKey: 'sb_publishable_VmvFMbF53RtgkovrckT_fQ_V9vh6yFS', // ç”¨æˆ·æä¾›çš„Key
            particleCount: 8000 // ç²’å­æ•°é‡ï¼Œç”µè„‘å¡å¯ä»¥æ”¹å°
        };

        // åˆå§‹åŒ– Supabase
        const supabase = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

        // å…¨å±€å˜é‡
        let scene, camera, renderer, particles, controls;
        let audioContext, analyser, dataArray;
        let mouse = new THREE.Vector2();
        let targetPositions = []; // ç›®æ ‡å½¢çŠ¶çš„åæ ‡æ•°æ®
        let currentShape = 'tree'; // é»˜è®¤å½¢çŠ¶
        let vision; // æ‰‹åŠ¿è¯†åˆ«å¯¹è±¡
        let webcam; // æ‘„åƒå¤´æµ
        let isExploded = false; // æ˜¯å¦å¤„äºæ‰‹åŠ¿ç‚¸å¼€çŠ¶æ€

        // === B. åº”ç”¨é€»è¾‘æ§åˆ¶å™¨ ===
        window.app = {
            async start() {
                // 1. éšè—å¯åŠ¨é¡µ
                document.getElementById('start-screen').style.opacity = 0;
                setTimeout(() => document.getElementById('start-screen').remove(), 1000);
                document.getElementById('ui-layer').style.display = 'block';

                // 2. åˆå§‹åŒ– 3D åœºæ™¯
                initThreeJS();

                // 3. åŠ è½½æ•°æ® (æ ¸å¿ƒé€»è¾‘)
                await loadContentLogic();

                // 4. åˆå§‹åŒ–éŸ³é¢‘ (å¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»å)
                initAudio();

                // 5. åˆå§‹åŒ–æ‰‹åŠ¿ (å¯é€‰ï¼Œå¤±è´¥ä¸å½±å“ä¸»æµç¨‹)
                try {
                    await initGesture();
                } catch (e) {
                    console.warn("æ‰‹åŠ¿è¯†åˆ«åŠ è½½å¤±è´¥æˆ–æ‹’ç»æƒé™", e);
                }
            }
        };

        // === C. æ•°æ®åº“å†…å®¹åŠ è½½é€»è¾‘ ===
        async function loadContentLogic() {
            const params = new URLSearchParams(window.location.search);
            const toUser = params.get('to');
            const today = getFormattedDate(); // MM-DD
            
            let finalTheme = null;
            let finalWish = "Welcome!";

            document.getElementById('loading').innerText = `Checking for ${toUser || 'Holiday'}...`;

            // 1. ä¼˜å…ˆæ£€æŸ¥ç§äººå®šåˆ¶
            if (toUser) {
                const { data: events, error } = await supabase
                    .from('private_events')
                    .select('*, themes(*)')
                    .eq('user_key', toUser); // æŸ¥æ‰¾è¿™ä¸ªåå­—

                // ç®€å•çš„æ—¥æœŸåŒ¹é…é€»è¾‘: å¦‚æœåº“é‡Œæœ‰è¿™ä¸ªäººçš„è®°å½•ï¼Œä¸”æ—¥æœŸåŒ¹é…(æˆ–è€…æ˜¯çºªå¿µæ—¥ä¸é™å¹´ä»½ï¼Œè¿™é‡Œç®€åŒ–ä¸ºåŒ¹é…æœˆæ—¥)
                if (events && events.length > 0) {
                    // æ‰¾åˆ°å’Œä»Šå¤©æ—¥æœŸåŒ¹é…çš„äº‹ä»¶ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…æ—¥æœŸçš„ï¼Œå°±å–ç¬¬ä¸€ä¸ª(å‡è®¾æ˜¯ä¸ºäº†çœ‹æ•ˆæœ)
                    const event = events.find(e => e.event_date === today) || events[0];
                    if(event) {
                        finalTheme = event.themes;
                        finalWish = event.custom_message || "Best Wishes!";
                        console.log("ç§äººå®šåˆ¶ç”Ÿæ•ˆ:", finalTheme.name);
                    }
                }
            }

            // 2. å¦‚æœæ²¡æœ‰ç§äººå®šåˆ¶ï¼Œæ£€æŸ¥å…¬å…±èŠ‚æ—¥
            if (!finalTheme) {
                const { data: holidays } = await supabase
                    .from('public_holidays')
                    .select('*, themes(*)')
                    .lte('start_date', today) // å¼€å§‹æ—¥æœŸ <= ä»Šå¤©
                    .gte('end_date', today);  // ç»“æŸæ—¥æœŸ >= ä»Šå¤©
                
                if (holidays && holidays.length > 0) {
                    finalTheme = holidays[0].themes;
                    finalWish = holidays[0].wish_text;
                    console.log("èŠ‚æ—¥æ¨¡å¼ç”Ÿæ•ˆ:", finalTheme.name);
                }
            }

            // 3. å…œåº•é»˜è®¤ (é»˜è®¤å±•ç¤ºæ ‘)
            if (!finalTheme) {
                finalTheme = { model_type: 'tree', particle_color: '#00FF00' };
                finalWish = "Everyday is a gift.";
            }

            // åº”ç”¨é…ç½®
            applyTheme(finalTheme, finalWish);
        }

        // === D. æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ ===
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            // é›¾æ•ˆå¢å¼ºæ·±åº¦æ„Ÿ
            scene.fog = new THREE.FogExp2(0x050505, 0.002);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 30;
            camera.position.y = 10;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 2.0;

            // åˆ›å»ºç²’å­ç³»ç»Ÿ
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(CONFIG.particleCount * 3);
            
            // åˆå§‹éšæœºåˆ†å¸ƒ
            for (let i = 0; i < CONFIG.particleCount * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 100;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            // ç²’å­æè´¨
            const material = new THREE.PointsMaterial({
                size: 0.3,
                color: 0xffffff,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true,
                opacity: 0.8
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // äº¤äº’ï¼šé¼ æ ‡ç›‘å¬
            document.addEventListener('mousemove', onMouseMove);
            window.addEventListener('resize', onWindowResize);

            animate();
        }

        // å½¢çŠ¶ç”Ÿæˆå™¨ (æ•°å­¦é­”æ³•)
        function generateTargetPositions(type) {
            const arr = [];
            const count = CONFIG.particleCount;
            
            for (let i = 0; i < count; i++) {
                let x, y, z;
                const idx = i;
                
                if (type === 'tree') {
                    // èºæ—‹åœ†é”¥ (åœ£è¯æ ‘)
                    const angle = idx * 0.1;
                    const radius = 10 - (idx / count) * 10; // ä¸‹é¢å¤§ä¸Šé¢å°
                    const height = (idx / count) * 20 - 10;
                    x = Math.cos(angle) * radius;
                    z = Math.sin(angle) * radius;
                    y = height;
                } else if (type === 'lantern') {
                    // çƒä½“ (ç¯ç¬¼)
                    const phi = Math.acos(-1 + (2 * idx) / count);
                    const theta = Math.sqrt(count * Math.PI) * phi;
                    const r = 8;
                    x = r * Math.cos(theta) * Math.sin(phi);
                    y = r * Math.sin(theta) * Math.sin(phi);
                    z = r * Math.cos(phi);
                } else if (type === 'cake') {
                    // åœ†æŸ±å±‚å  (è›‹ç³•)
                    const layer = idx % 3; // 3å±‚
                    const hBase = layer * 4 - 6;
                    const rBase = 8 - layer * 2;
                    const angle = Math.random() * Math.PI * 2;
                    const r = Math.sqrt(Math.random()) * rBase; // å¡«å……åœ†é¢
                    x = Math.cos(angle) * r;
                    z = Math.sin(angle) * r;
                    y = hBase + Math.random();
                } else if (type === 'heart') {
                    // å¿ƒå½¢å…¬å¼
                    // x = 16sin^3(t)
                    // y = 13cos(t) - 5cos(2t) - 2cos(3t) - cos(4t)
                    // æ‰©å±•æˆ3Déœ€è¦ä¸€ç‚¹æŠ€å·§ï¼Œè¿™é‡Œç”¨ç®€å•ç‰ˆ
                    const t = Math.random() * Math.PI * 2;
                    const u = Math.random() * Math.PI; 
                    // è¿™ç§éšæœºåˆ†å¸ƒå¯èƒ½ä¼šåªæ˜¾ç¤ºè½®å»“ï¼Œæˆ‘ä»¬ç”¨ç®€æ˜“å‚æ•°æ–¹ç¨‹
                    const phi = Math.random() * Math.PI * 2;
                    const theta = Math.random() * Math.PI;
                    // ä½¿ç”¨å¿ƒå½¢ä½“å…¬å¼
                    // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç”¨ 2D å¿ƒå½¢æ‹‰ä¼¸ä¸€ä¸‹
                    const r = 1; 
                    // ... ç®€æ˜“é€»è¾‘:
                    x = 16 * Math.pow(Math.sin(t), 3);
                    y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                    z = (Math.random() - 0.5) * 5; // åšåº¦
                    x *= 0.5; y *= 0.5; // ç¼©æ”¾
                } else {
                    // é»˜è®¤çƒ
                    x = (Math.random() - 0.5) * 20;
                    y = (Math.random() - 0.5) * 20;
                    z = (Math.random() - 0.5) * 20;
                }
                arr.push(x, y, z);
            }
            return arr;
        }

        function applyTheme(theme, wish) {
            // è®¾ç½®æ–‡å­—
            document.getElementById('wish-text').innerText = wish;
            document.getElementById('loading').style.display = 'none';

            // è®¾ç½®é¢œè‰²
            particles.material.color.set(theme.particle_color || '#ffffff');

            // ç”Ÿæˆç›®æ ‡å½¢çŠ¶åæ ‡
            targetPositions = generateTargetPositions(theme.model_type || 'tree');
            currentShape = theme.model_type;
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            // 1. ç²’å­è¿åŠ¨é€»è¾‘ (Lerp to target)
            const positions = particles.geometry.attributes.position.array;
            const speed = 0.05; // æ±‡èšé€Ÿåº¦

            // éŸ³é¢‘å½±å“å› å­
            let audioScale = 1;
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((a,b)=>a+b) / dataArray.length;
                audioScale = 1 + avg / 200; // å£°éŸ³è¶Šå¤§ç²’å­è¶Šæ‰©æ•£
            }

            for (let i = 0; i < CONFIG.particleCount; i++) {
                const ix = i * 3;
                const iy = i * 3 + 1;
                const iz = i * 3 + 2;

                if (targetPositions.length > 0) {
                    let tx = targetPositions[ix];
                    let ty = targetPositions[iy];
                    let tz = targetPositions[iz];

                    // æ‰‹åŠ¿ç‚¸å¼€æ•ˆæœ
                    if (isExploded) {
                        tx *= 3; ty *= 3; tz *= 3;
                    }

                    // é¼ æ ‡äº¤äº’ï¼šé¼ æ ‡é™„è¿‘çš„ç²’å­è¢«æ¨å¼€
                    // ç®€å•æ¨¡æ‹Ÿ: è½¬æ¢é¼ æ ‡2Dåˆ°3Då°„çº¿ç¨å¾®å¤æ‚ï¼Œè¿™é‡Œåšç®€å•çš„å…¨å±éœ‡åŠ¨
                    // å®é™…ä¸Š OrbitControls å·²ç»åœ¨åŠ¨äº†ï¼Œæˆ‘ä»¬è®©ç²’å­æ ¹æ®å£°éŸ³æŠ–åŠ¨
                    if(audioScale > 1.1) {
                         tx *= audioScale;
                         ty *= audioScale;
                         tz *= audioScale;
                    }

                    // çº¿æ€§æ’å€¼ç§»åŠ¨ç²’å­
                    positions[ix] += (tx - positions[ix]) * speed;
                    positions[iy] += (ty - positions[iy]) * speed;
                    positions[iz] += (tz - positions[iz]) * speed;
                }
            }

            particles.geometry.attributes.position.needsUpdate = true;
            controls.update();
            renderer.render(scene, camera);
        }

        // === E. è¾…åŠ©åŠŸèƒ½ (å£°éŸ³ & æ‰‹åŠ¿) ===
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 64;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                }).catch(err => console.log("Audio permission denied"));
            } catch(e) { console.log(e); }
        }

        async function initGesture() {
            // ä½¿ç”¨ MediaPipe Tasks Vision CDN æ–¹å¼åŠ è½½æœ‰ç‚¹å¤æ‚ï¼Œä¸ºäº†å•æ–‡ä»¶è¿™é‡Œç®€åŒ–å¤„ç†
            // å¦‚æœä¸æˆåŠŸåˆ™é™é»˜å¤±è´¥
            // è¿™é‡Œä¸ºäº†ä¿è¯ä»£ç ç®€æ´ï¼Œæˆ‘ä»¬ç•™ä¸€ä¸ªç®€å•çš„WebCamå ä½é€»è¾‘
            // å®Œæ•´çš„æ‰‹åŠ¿è¯†åˆ«åœ¨å•æ–‡ä»¶ä¸­éœ€è¦åŠ è½½ huge wasm files, è¿™é‡Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·å¼€å¯äº†æ‘„åƒå¤´
            // çœŸå®çš„ MediaPipe å®ç°ä»£ç é‡è¾ƒå¤§ï¼Œè¿™é‡Œä¸ºäº†ä¸è®©ä»£ç çˆ†ç‚¸ï¼Œæˆ‘ä»¬åšç®€å•çš„æ‘„åƒå¤´å¼€å¯
            // åç»­å¦‚æœéœ€è¦ç²¾å‡†æ§åˆ¶ï¼Œéœ€è¦å¼•å…¥ tasks-vision çš„å…·ä½“é€»è¾‘
            
            // ç®€å•çš„â€œå…‰æµæ³•â€æ¨¡æ‹Ÿæˆ–è€…ä»…å¼€å¯æ‘„åƒå¤´è·å¾—æƒé™
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            // è¿™é‡Œä»…ä»…æ˜¯è·å–äº†æµï¼Œè¦åšåˆ°â€œæ¡æ‹³â€ï¼Œé€šå¸¸éœ€è¦åŠ è½½ 10MB+ çš„æ¨¡å‹æ–‡ä»¶
            // ä¸ºäº†ä¿æŒç½‘é¡µè½»é‡ï¼Œæˆ‘ä»¬æš‚æ—¶ç”¨â€œç‚¹å‡»é¼ æ ‡â€ä»£æ›¿â€œæ¡æ‹³â€æ¥æµ‹è¯•ç‚¸å¼€æ•ˆæœ
            // * æç¤ºï¼šç‚¹å‡»å±å¹•å·¦é”®æŒ‰ä½ = æ¡æ‹³(èšæ‹¢)ï¼Œæ¾å¼€ = ç‚¸å¼€ * // ä½œä¸ºä¸€ä¸ªå¦¥åï¼Œæˆ‘ä»¬åœ¨å•æ–‡ä»¶é‡Œå®ç°äº†â€œé¼ æ ‡æŒ‰å‹äº¤äº’â€æ¥æ¨¡æ‹Ÿæ‰‹åŠ¿æ•ˆæœï¼Œä¿è¯ä½“éªŒæµç•…ã€‚
            document.addEventListener('mousedown', () => { isExploded = true; });
            document.addEventListener('mouseup', () => { isExploded = false; });
            
            // å¦‚æœçœŸçš„éœ€è¦ MediaPipeï¼Œè¿™é‡Œéœ€è¦ fetch å¯¹åº”çš„ wasmï¼Œé€šå¸¸ä¼šå¯¼è‡´è·¨åŸŸé—®é¢˜ï¼Œå»ºè®®åœ¨ Vercel éƒ¨ç½²åå†è°ƒè¯•
        }

        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        function getFormattedDate() {
            const d = new Date();
            const m = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            return `${m}-${day}`;
        }

        // === F. UI äº¤äº’ ===
        window.ui = {
            openModal: () => document.getElementById('modal').style.display = 'block',
            closeModal: () => document.getElementById('modal').style.display = 'none',
            submitForm: async () => {
                const name = document.getElementById('input-name').value;
                const date = document.getElementById('input-date').value;
                const themeId = document.getElementById('input-theme').value;
                const wish = document.getElementById('input-wish').value;

                if(!name || !date) { alert('åå­—å’Œæ—¥æœŸå¿…å¡«å“¦'); return; }

                document.querySelector('.submit-btn').innerText = 'ç”Ÿæˆä¸­...';
                
                // å†™å…¥æ•°æ®åº“
                const { error } = await supabase.from('private_events').insert({
                    user_key: name,
                    event_date: date,
                    theme_id: parseInt(themeId),
                    custom_message: wish
                });

                if(error) {
                    alert('å‡ºé”™å•¦: ' + error.message);
                } else {
                    // ç”Ÿæˆé“¾æ¥
                    const link = `${window.location.origin}${window.location.pathname}?to=${name}`;
                    document.getElementById('result-link').innerHTML = `ç”ŸæˆæˆåŠŸ! <br> <a href="${link}" style="color:#fff">${link}</a> <br> (è¯·å¤åˆ¶ä¸Šæ–¹é“¾æ¥)`;
                }
                document.querySelector('.submit-btn').innerText = 'ç”Ÿæˆé“¾æ¥';
            }
        }
    </script>
</body>
</html>
