<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²‰æµ¸å¼èŠ‚æ—¥ç¥ç¦å¼•æ“ (Stable)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; color: white; font-family: sans-serif; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; transition: opacity 0.5s; font-weight: 300; letter-spacing: 1px; }
        #ui-layer { position: absolute; bottom: 30px; left: 0; width: 100%; text-align: center; pointer-events: none; z-index: 10; }
        .btn { pointer-events: auto; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px 24px; border-radius: 30px; cursor: pointer; backdrop-filter: blur(10px); transition: 0.3s; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .btn:hover { background: rgba(255,255,255,0.25); transform: scale(1.05); }
        #debug-info { position: absolute; top: 10px; left: 10px; color: rgba(255,255,255,0.3); font-size: 10px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="loading">æ­£åœ¨è¿æ¥èŠ‚æ—¥å¼•æ“...</div>
    <div id="debug-info"></div>
    
    <div id="ui-layer">
        <h1 id="theme-title" style="margin-bottom: 20px; font-weight: 200; font-size: 1.5rem; text-shadow: 0 0 20px rgba(255,215,0,0.5);">...</h1>
        <button id="sound-btn" class="btn">ğŸ”Š å¼€å¯å£°éŸ³äº’åŠ¨</button>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { createClient } from '@supabase/supabase-js';

        // --- 1. ç¨³å®šçš„é…ç½® ---
        const SUPABASE_URL = 'https://tcviiqrcgijnxgwmzjkq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_VmvFMbF53RtgkovrckT_fQ_V9vh6yFS';
        
        const debugEl = document.getElementById('debug-info');
        const titleEl = document.getElementById('theme-title');
        const loadingEl = document.getElementById('loading');

        // --- 2. åœºæ™¯åˆå§‹åŒ– ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.02);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 12);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.8;
        controls.maxDistance = 20;
        controls.minDistance = 5;

        // --- 3. ç²’å­æ ‘ç”Ÿæˆé€»è¾‘ ---
        let particles;
        function createTree(config) {
            if(particles) scene.remove(particles);

            const count = config.visual.particleCount || 2500;
            const color1 = new THREE.Color(config.visual.primaryColor || '#FFD700');
            const color2 = new THREE.Color(config.visual.secondaryColor || '#FF0000');

            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const sizes = [];

            for (let i = 0; i < count; i++) {
                const iNorm = i / count; 
                const angle = i * 0.15; 
                
                // åœ£è¯æ ‘å½¢æ€ï¼šä¸‹å®½ä¸Šçª„
                const height = (iNorm * 12) - 6; 
                const radius = (1 - iNorm) * 4; 
                
                const spiralX = Math.cos(angle) * radius;
                const spiralZ = Math.sin(angle) * radius;

                // éšæœºæ‰°åŠ¨ (Jitter)
                const jitter = 0.3;
                positions.push(
                    spiralX + (Math.random() - 0.5) * jitter, 
                    height + (Math.random() - 0.5) * jitter, 
                    spiralZ + (Math.random() - 0.5) * jitter
                );

                const mixedColor = color1.clone().lerp(color2, Math.random());
                colors.push(mixedColor.r, mixedColor.g, mixedColor.b);
                
                // é¡¶éƒ¨ç²’å­æ›´å°æ›´å¯†
                sizes.push(Math.random() * 1.5); 
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

            // è‡ªå®šä¹‰æè´¨ï¼ˆè®©ç²’å­åœ†æ¶¦å‘å…‰ï¼‰
            const material = new THREE.PointsMaterial({
                size: 0.15,
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true,
                opacity: 0.9
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // --- 4. å¼ºå£®çš„æ•°æ®åŠ è½½é€»è¾‘ ---
        async function initEngine() {
            // é»˜è®¤å…œåº•é…ç½® (Fail-safe)
            const fallbackConfig = {
                name: "æœ¬åœ°å¤‡ä»½æ¨¡å¼",
                config: {
                    visual: { primaryColor: '#00ffaa', secondaryColor: '#ffffff', particleCount: 3000 }
                }
            };

            try {
                debugEl.innerText = "Connecting to DB...";
                const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // å°è¯•è¯»å–æ•°æ®åº“
                const { data, error } = await supabase
                    .from('themes')
                    .select('*')
                    .eq('is_active', true)
                    .maybeSingle(); // ä½¿ç”¨ maybeSingle é¿å… 406 é”™è¯¯

                if (error) throw error;
                if (!data) throw new Error("æ²¡æœ‰æ‰¾åˆ°æ¿€æ´»çš„ä¸»é¢˜");

                // æˆåŠŸï¼
                debugEl.innerText = "Connected: " + data.name;
                titleEl.innerText = data.name;
                createTree(data.config);

            } catch (err) {
                // å¤±è´¥å¤„ç†
                console.warn("å¼•æ“é™çº§è¿è¡Œ:", err);
                debugEl.innerText = "Offline Mode: " + err.message;
                titleEl.innerText = fallbackConfig.name;
                createTree(fallbackConfig.config);
            }
            
            loadingEl.style.opacity = 0;
        }

        // --- 5. åŠ¨ç”»å¾ªç¯ ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (particles) {
                const time = Date.now() * 0.001;
                particles.rotation.y = time * 0.1;
                // ç®€å•çš„é—ªçƒæ•ˆæœ
                particles.material.size = 0.15 + Math.sin(time * 5) * 0.05;
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        initEngine();
        animate();
    </script>
</body>
</html>
